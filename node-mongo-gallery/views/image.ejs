<!doctype html>
<html>
<head>
  <%- include('partials/header', {'page': page}) %>
  
<%
	     let seriesName = "";
	     let seriesSeq = "";
	     let seriesCount = 0;
	     if (data["series"] !== null && data["series"]!==undefined) {
	        if (data["series"]["name"] !== null && data["series"]["name"] !== undefined) seriesName = data.series.name;
	        if (data["series"]["sequence"] !== null && data["series"]["sequence"] !== undefined) seriesSeq = data.series.sequence;
	        if (data["series"]["count"] !== null && data["series"]["count"] !== undefined) seriesCount = data.series.count;
	     }
%>
  
<script>
	function setSequenceImage(id) {
		var sequence = $("input[name=sequence]").val();
		var series_name = $("input[name=series_name]").val();
		setSequence(id,series_name,sequence);
	}
</script>
<%
  if (data["series"] !== null && data["series"] !== undefined) {
    if (seriesCount >= 1) { %>
<script>
 // left-right keypad for navigation
$(window).keydown(function(e) {
    if(e.which === 39) {
        <% if (seriesSeq < seriesCount) { %>
    	window.location.href = '/image?series=<%=seriesName%>&sequence=<%=seriesSeq + 1%>';
    	<% } %>
    } else if(e.which === 37) {
        <% if (seriesSeq > 1) { %>
		window.location.href = '/image?series=<%=seriesName%>&sequence=<%=seriesSeq - 1%>';
		<% } %>
    }
});
</script>
<%  }
  } %>
</head>
<body>
  <%- include('partials/navbar', {'config':config, 'user':user}) %>
  <div id="centerpage" class="container-fluid">
  	<div class="row">
	  <div id="leftcolumn" class="col-2">
        <%- include('partials/searchbox', {'config':config, 'page':page, 'search':search}) %>
    <div class="taglist">
    	<span style="font-size: 12px">Image Tags</span>
    	<% 
    	  data["tags"] = data["tags"].sort();
    	  for (let x=0; x<data["tags"].length; x++) { 
    	    let tag = data["tags"][x]; %>
		<div class="tag" id="<%=tag%>"><a href="/gallery?tags=<%=tag%>&page=1"><%=tag%></a> <% if (user!=null) { %><img src="/images/delete-sm.png" class="delete-button" onClick="javascript:deleteTag('<%=data._id.toString()%>','<%=tag%>');"/><% } %></div>
	    <% } %>
	</div>
	<% if (user!==null) { %>
		<div class="tag">
			<form name="addtag" method="post" action="" onsubmit="addTag('<%=data._id.toString()%>');return false;">
			  <div class="form-group">
				<label for="newtag" style="font-size: 12px">Add Tag</label>
				<input type="text" name="newtag" value="" id="newtag" class="form-control"/>
			  </div>
  			  <button type="button" class="button btn-primary add-button" onClick="addTag('<%=data._id.toString()%>');">Add</button>
			</form>
		</div>
	<% } %>
	<% if (data.tags.indexOf('series') >=0) { 
	%>
		<span style="font-size: 12px">Series Info</span>
		<div class="series">
		<% if (user!==null) { %>
			<form name="setsequence" method="post" action="" onsubmit="setSequenceImage('<%=data._id.toString()%>');return false;">
				<input type="text" name="series_name" value="<%=seriesName%>"/>
				<input type="text" name="sequence" value="<%=seriesSeq%>"/>
				<input type="button" name="set" value="set" class="set-button" onClick="javascript:setSequenceImage('<%=data._id.toString()%>');"/>
			</form>
	 	<% } else { %>
	 		<span style="font-size: 12px">Series: <%=seriesName%></span>
	 	 	<span style="font-size: 12px">Sequence: <%=seriesSeq%></span>
	 	<% } %>
	 		<div style="font-size: 12px">Series: <a href="/gallery?series=<%=seriesName%>"><%=seriesName%></a></div>
			<div style="font-size: 12px">Images in series: <%=seriesCount%></div>
		</div>
	<% } %>
	<% if (user!==null) { %>
		<% if (data["deleted"]) { %>
		<div class="delete">
			<input type="button" name="undelete" value="Un-Delete Image" class="delete-image" onClick="javascript:unDeleteImage('<%=data._id.toString()%>');"/>
		</div>
		<% }else {%>
		<div class="delete">
			<input type="button" name="delete" value="Delete Image" class="delete-image" onClick="javascript:deleteImage('<%=data._id.toString()%>');"/>
		</div>
		<% } %>
	<% } %>
	<div class="imagedetail">
		<div id="original">Original: <%=data.original%></div>
		<div id="uploaded">Uploaded on: <%=new Date(data.date).toDateString()%></div>
	</div>
      </div>
      <div id="main" class="col">
		<div id="alert"><%=errorMsg%></div>
	<div>
		<% if (seriesCount >= 1) { %>
		<ul id="seriesnav" class="pagination mt-1">
			<% if (seriesSeq > 1) { %>
				<li class="page-item"><a class="page-link" href="image?series=<%=seriesName%>&sequence=<%=seriesSeq - 1%>">&lt;&lt;&lt; Prev</a></li>
			<% } %>
			<li class="page-item disabled"><a class="page-link disabled"><%=seriesSeq%> of <%=seriesCount%></a></li>
			<% if (seriesSeq < seriesCount) { %>
				<li class="page-item"><a class="page-link" href="image?series=<%=seriesName%>&sequence=<%=seriesSeq + 1%>">Next &gt;&gt;&gt;</a></li>
			<% } %>
		</ul>
		<% } %>
	<div id="image" class="mt-1">
		<img id="mainimage" class="figure-img img-fluid" src="/<%=data.location%>"/>
	</div>
		<% if (seriesCount >= 1) { %>
		<ul id="seriesnav" class="pagination mt-1">
			<% if (seriesSeq > 1) { %>
				<li class="page-item"><a class="page-link" href="image?series=<%=seriesName%>&sequence=<%=seriesSeq - 1%>">&lt;&lt;&lt; Prev</a></li>
			<% } %>
			<li class="page-item disabled"><a class="page-link disabled"><%=seriesSeq%> of <%=seriesCount%></a></li>
			<% if (seriesSeq < seriesCount) { %>
				<li class="page-item"><a class="page-link" href="image?series=<%=seriesName%>&sequence=<%=seriesSeq + 1%>">Next &gt;&gt;&gt;</a></li>
			<% } %>
		</ul>
		<% } %>
		<% if (config.allowComments) { %>
			<div id="comments">
			<% if (Array.isArray(data["comments"])) {
			     for (let x=0;x<data["comments"].length;x++) {
			       let comment = data["comments"][x]; %>
				<div id="comment">
					<div id="commentuser"><%=comment.user%></div>
					<div id="commentdate">Posted: <%=new Date(comment.date).toDateString()%></div>
					<div id="commenttext"><%=comment.comment%></div>
				</div>
			<%  }
			  } %>
			<% if (user!==null || config.allowAnonymousComments) { %>
				<div id="comment">
					<form name="comment" action="/addComment" method="POST">
						<div id="commentuser"><% if (user!==null) { %><%=user.local.email%><% } else { %>Anonymous<% } %></div>
						<div id="commenttext"><textarea cols="50" rows="6" name="comment"></textarea></div>
						<input type="submit" name="Add Comment" value="Add Comment"/>
						<input type="hidden" name="id" value="<%=data._id.toString()%>"/>
					</form>
				</div>
			<% } %>
			</div>
		<% } %>
	</div>
	  </div>
	</div>
  </div>
  <%- include('partials/footer') %>
</body>
</html>
      